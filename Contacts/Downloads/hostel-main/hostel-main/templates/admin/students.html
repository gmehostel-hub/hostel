{% extends "base.html" %}

{% block title %}Students - Admin{% endblock %}

{% block content %}
<div class="p-4">
    <h1 class="text-2xl font-bold mb-4">Students</h1>

    <!-- Toolbar -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-4 gap-3">
        <div class="relative w-full md:max-w-md">
            <input id="studentSearch" type="text" placeholder="Search by name, email, or room..." 
                   class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
        </div>
        <div class="flex items-center gap-3">
            <span id="studentsCount" class="text-sm text-gray-600"></span>
            <!-- Add Student Button -->
            <button type="button" class="bg-blue-600 text-white px-4 py-2 rounded"
                    onclick="document.getElementById('addStudentModal').classList.remove('hidden')">
                Add Student
            </button>
        </div>
    </div>
    
    <!-- Students List -->
    <div class="bg-white rounded shadow overflow-x-auto">
        <table class="min-w-full">
            <thead>
                <tr class="bg-gray-100">
                    <th class="px-4 py-2 text-left">Name</th>
                    <th class="px-4 py-2 text-left">Email</th>
                    <th class="px-4 py-2">Room</th>
                    <th class="px-4 py-2 text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for student in students %}
                <tr class="border-t student-row cursor-pointer hover:bg-gray-50"
                    data-student-id="{{ student._id }}"
                    data-name="{{ student.name }}"
                    data-email="{{ student.email }}"
                    data-room="{{ student.room_number or '' }}">
                    <td class="px-4 py-2">{{ student.name }}</td>
                    <td class="px-4 py-2">{{ student.email }}</td>
                    <td class="px-4 py-2 text-center">{{ student.room_number or '-' }}</td>
                    <td class="px-4 py-2 text-center">
                        <button type="button" class="text-blue-600 hover:text-blue-800 mr-3 edit-btn" title="Edit"
                                data-student-id="{{ student._id }}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="text-red-600 hover:text-red-800 delete-btn" title="Delete"
                                data-student-id="{{ student._id }}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" class="px-4 py-2 text-center text-gray-500">No students found</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    <div id="studentsPagination" class="mt-4 flex justify-center"></div>

    <!-- Hidden generic delete form -->
    <form id="deleteStudentForm" method="POST" class="hidden"></form>
</div>

<!-- Add Student Modal -->
<div id="addStudentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold">Add New Student</h2>
            <button onclick="document.getElementById('addStudentModal').classList.add('hidden')">
                <i class="fas fa-times text-gray-500"></i>
            </button>
        </div>
        
        <form method="POST" action="{{ url_for('add_student') }}">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Full Name</label>
                    <input type="text" name="name" required 
                           class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Email</label>
                    <input type="email" name="email" required
                           class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Phone Number</label>
                    <input type="tel" name="phone" required
                           class="w-full p-2 border rounded" placeholder="e.g., 9876543210">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">SWD ID</label>
                    <input type="text" name="swd_id" required class="w-full p-2 border rounded" placeholder="Enter SWD ID">
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">Year</label>
                        <select name="year" required class="w-full p-2 border rounded">
                            <option value="" disabled selected>Select year</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">Stream</label>
                        <select name="stream" required class="w-full p-2 border rounded">
                            <option value="" disabled selected>Select stream</option>
                            <option value="engineering">Engineering</option>
                            <option value="medical">Medical</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Branch</label>
                    <input type="text" name="branch" required class="w-full p-2 border rounded" placeholder="e.g., CSE, ECE">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">College</label>
                    <input type="text" name="college" required class="w-full p-2 border rounded">
                </div>
                <div class="flex justify-end space-x-2 pt-2">
                    <button type="button" 
                            onclick="document.getElementById('addStudentModal').classList.add('hidden')"
                            class="px-4 py-2 border rounded">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-blue-600 text-white rounded">
                        Add Student
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- View Student Modal -->
<div id="viewStudentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg w-full max-w-lg shadow-lg z-10">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-lg font-semibold">Student Details</h3>
            <button class="p-1" onclick="toggleModal('viewStudentModal', true)"><i class="fas fa-times text-gray-500"></i></button>
        </div>
        <div id="viewStudentBody" class="p-4 text-sm"></div>
        <div class="flex justify-end gap-2 p-4 border-t">
            <button class="px-4 py-2 border rounded" onclick="toggleModal('viewStudentModal', true)">Close</button>
        </div>
    </div>
    <script></script>
    
    
</div>

<!-- Edit Student Modal -->
<div id="editStudentModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg w-full max-w-lg shadow-lg z-10">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 class="text-lg font-semibold">Edit Student</h3>
            <button class="p-1" onclick="toggleModal('editStudentModal', true)"><i class="fas fa-times text-gray-500"></i></button>
        </div>
        <form id="editStudentForm" method="POST" action="#" class="p-4 space-y-3">
            <div>
                <label class="block text-sm font-medium mb-1">Full Name</label>
                <input type="text" name="name" class="w-full p-2 border rounded" required>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">Email</label>
                <input type="email" name="email" class="w-full p-2 border rounded" required>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Phone</label>
                    <input type="tel" name="phone" class="w-full p-2 border rounded">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Year</label>
                    <input type="number" min="1" max="5" name="year" class="w-full p-2 border rounded">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">SWD ID</label>
                <input type="text" name="swd_id" required class="w-full p-2 border rounded" placeholder="Enter SWD ID">
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Stream</label>
                    <select name="stream" class="w-full p-2 border rounded">
                        <option value="engineering">Engineering</option>
                        <option value="medical">Medical</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Branch</label>
                    <input type="text" name="branch" class="w-full p-2 border rounded">
                </div>
            </div>
            <div>
                <label class="block text-sm font-medium mb-1">College</label>
                <input type="text" name="college" class="w-full p-2 border rounded">
            </div>
            <div class="flex justify-end gap-2 pt-2 border-t">
                <button type="button" class="px-4 py-2 border rounded" onclick="toggleModal('editStudentModal', true)">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
            </div>
        </form>
    </div>
</div>

<script>
    // Utility to open/close modal
    function toggleModal(id, hide) {
        const el = document.getElementById(id);
        if (!el) return;
        if (hide) el.classList.add('hidden'); else el.classList.remove('hidden');
    }

    // Setup filtering, sorting (alphabetical), and pagination (10/page)
    (function() {
        const allRows = Array.from(document.querySelectorAll('.student-row'));
        const search = document.getElementById('studentSearch');
        const countEl = document.getElementById('studentsCount');
        const deleteForm = document.getElementById('deleteStudentForm');
        const pager = document.getElementById('studentsPagination');
        const perPage = 10;
        let current = 1;
        let currentRows = [];

        function sortByName(rows) {
            const arr = [...rows];
            arr.sort((a,b) => (a.getAttribute('data-name')||'').localeCompare(b.getAttribute('data-name')||'', undefined, {sensitivity:'base'}));
            return arr;
        }

        function updateCount(visible) {
            if (countEl) countEl.textContent = `${visible} of ${allRows.length} students`;
        }

        function applyFilter() {
            const q = (search?.value || '').trim().toLowerCase();
            const filtered = allRows.filter(tr => {
                const name = (tr.getAttribute('data-name') || '').toLowerCase();
                const email = (tr.getAttribute('data-email') || '').toLowerCase();
                const room = String(tr.getAttribute('data-room') || '').toLowerCase();
                return !q || name.includes(q) || email.includes(q) || room.includes(q);
            });
            currentRows = sortByName(filtered);
            updateCount(currentRows.length);
            renderPage(1);
        }

        function renderPage(n) {
            // hide all
            allRows.forEach(tr => { tr.style.display = 'none'; });
            const totalPages = Math.max(1, Math.ceil(currentRows.length / perPage));
            current = Math.min(Math.max(1, n), totalPages);
            const start = (current - 1) * perPage;
            const end = start + perPage;
            currentRows.slice(start, end).forEach(tr => { tr.style.display = ''; });
            renderPager(totalPages);
        }

        function renderPager(totalPages) {
            if (!pager) return;
            pager.innerHTML = '';
            if (currentRows.length === 0) return;
            const nav = document.createElement('nav');
            nav.className = 'inline-flex rounded-md shadow overflow-hidden';
            const prev = document.createElement('button');
            prev.className = 'px-3 py-2 border border-gray-300 bg-white text-gray-600 hover:bg-gray-50';
            prev.innerHTML = '<i class="fas fa-chevron-left"></i>';
            prev.disabled = current === 1;
            prev.onclick = () => renderPage(current - 1);
            nav.appendChild(prev);
            for (let i = 1; i <= totalPages; i++) {
                const b = document.createElement('button');
                b.className = 'px-4 py-2 border-t border-b border-gray-300 ' + (i === current ? 'bg-blue-600 text-white font-medium' : 'bg-white text-gray-700 hover:bg-gray-50');
                b.textContent = String(i);
                b.onclick = () => renderPage(i);
                nav.appendChild(b);
            }
            const next = document.createElement('button');
            next.className = 'px-3 py-2 border border-gray-300 bg-white text-gray-600 hover:bg-gray-50';
            next.innerHTML = '<i class="fas fa-chevron-right"></i>';
            next.disabled = current >= totalPages;
            next.onclick = () => renderPage(current + 1);
            nav.appendChild(next);
            pager.appendChild(nav);
        }

        function attachRowHandlers() {
            allRows.forEach(tr => {
                tr.addEventListener('click', () => openDetails(tr.getAttribute('data-student-id')));
            });
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = btn.getAttribute('data-student-id');
                    openEdit(id);
                });
            });
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const id = btn.getAttribute('data-student-id');
                    if (confirm('Are you sure you want to delete this student?')) {
                        if (deleteForm) {
                            deleteForm.action = `/admin/students/${id}/delete`;
                            deleteForm.submit();
                        }
                    }
                });
            });
        }

        async function openDetails(id) {
            try {
                const res = await fetch(`/api/students/${id}`);
                const s = await res.json();
                const body = document.getElementById('viewStudentBody');
                if (res.ok && body) {
                    body.innerHTML = `
                        <div class='grid grid-cols-1 sm:grid-cols-2 gap-3'>
                            <div><span class='text-gray-500'>Name</span><div class='font-medium'>${s.name || ''}</div></div>
                            <div><span class='text-gray-500'>Email</span><div class='font-medium break-all'>${s.email || ''}</div></div>
                            <div><span class='text-gray-500'>Phone</span><div class='font-medium'>${s.phone || '-'}</div></div>
                            <div><span class='text-gray-500'>SWD ID</span><div class='font-medium'>${s.swd_id || '-'}</div></div>
                            <div><span class='text-gray-500'>Room</span><div class='font-medium'>${s.room_number ?? '-'}</div></div>
                            <div><span class='text-gray-500'>Year</span><div class='font-medium'>${s.year ?? '-'}</div></div>
                            <div><span class='text-gray-500'>Stream</span><div class='font-medium capitalize'>${(s.stream || '-') }</div></div>
                            <div><span class='text-gray-500'>Branch</span><div class='font-medium'>${s.branch || '-'}</div></div>
                            <div><span class='text-gray-500'>College</span><div class='font-medium'>${s.college || '-'}</div></div>
                        </div>
                        <div class='flex justify-end gap-2 mt-4'>
                            <button class='px-3 py-2 border rounded' onclick="toggleModal('viewStudentModal', true)">Close</button>
                            <button class='px-3 py-2 bg-blue-600 text-white rounded' onclick="toggleModal('viewStudentModal', true); openEdit('${id}')">Edit</button>
                        </div>`;
                    toggleModal('viewStudentModal');
                } else {
                    alert(s?.error || 'Failed to load student');
                }
            } catch (e) {
                alert('Failed to load student');
            }
        }

        async function openEdit(id) {
            try {
                const res = await fetch(`/api/students/${id}`);
                const s = await res.json();
                if (!res.ok) throw new Error(s?.error || 'Failed');
                const form = document.getElementById('editStudentForm');
                if (!form) return;
                form.action = `/admin/students/${id}/edit`;
                form.name.value = s.name || '';
                form.email.value = s.email || '';
                form.phone.value = s.phone || '';
                form.year.value = s.year ?? '';
                form.stream.value = s.stream || 'engineering';
                form.branch.value = s.branch || '';
                form.college.value = s.college || '';
                form.swd_id.value = s.swd_id || '';
                toggleModal('editStudentModal');
            } catch (e) {
                alert('Failed to load student for edit');
            }
        }

        // Expose needed functions to global for inline handlers in modal HTML
        window.openEdit = openEdit;

        // Close modals only when clicking on their backdrops (not inner content)
        const vsm = document.getElementById('viewStudentModal');
        const esm = document.getElementById('editStudentModal');
        if (vsm) vsm.addEventListener('click', (e) => { if (e.target === vsm) toggleModal('viewStudentModal', true); });
        if (esm) esm.addEventListener('click', (e) => { if (e.target === esm) toggleModal('editStudentModal', true); });

        if (search) search.addEventListener('input', applyFilter);
        attachRowHandlers();
        applyFilter(); // initial sort + paginate (10 per page)
    })();
</script>
{% endblock %}
