{% extends "base.html" %}

{% block title %}Books - Admin{% endblock %}

{% block content %}
<div class="p-4">
  <div class="flex items-center justify-between mb-4 gap-3 flex-col md:flex-row">
    <h1 class="text-2xl font-bold">Library - Books</h1>
    <div class="flex items-center gap-3 w-full md:w-auto">
      <div class="relative w-full md:w-80">
        <input id="bookSearch" type="text" placeholder="Search by ID, title, or author..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
      </div>
      <button class="bg-blue-600 text-white px-4 py-2 rounded" onclick="toggleModal('addBookModal')">Add Book</button>
      <a href="{{ url_for('admin_transactions') }}" class="px-4 py-2 border rounded">Transactions</a>
    </div>
  </div>

  <div class="bg-white rounded shadow overflow-x-auto">
    <table class="min-w-full">
      <thead>
        <tr class="bg-gray-100 text-left">
          <th class="px-4 py-2">Book ID</th>
          <th class="px-4 py-2">Title</th>
          <th class="px-4 py-2">Author</th>
          <th class="px-4 py-2 text-right">Price</th>
          <th class="px-4 py-2 text-center">Status</th>
          <th class="px-4 py-2 text-center">Actions</th>
        </tr>
      </thead>
      <tbody id="booksTbody">
        {% for b in books %}
        <tr class="border-t book-row" data-book-oid="{{ b._id }}" data-book-id="{{ b.book_id }}" data-title="{{ b.title }}" data-author="{{ b.author }}" data-status="{{ b.status }}">
          <td class="px-4 py-2 font-mono">{{ b.book_id }}</td>
          <td class="px-4 py-2">{{ b.title }}</td>
          <td class="px-4 py-2">{{ b.author }}</td>
          <td class="px-4 py-2 text-right">{{ '%.2f' % b.price if b.price is not none }}</td>
          <td class="px-4 py-2 text-center">
            <span class="px-2 py-1 rounded text-xs {{ 'bg-green-100 text-green-700' if b.status=='available' else 'bg-yellow-100 text-yellow-700' }}">{{ b.status|capitalize }}</span>
          </td>
          <td class="px-4 py-2 text-center whitespace-nowrap">
            <button class="text-blue-600 hover:text-blue-800 mr-3" onclick="openEdit(this)" title="Edit"><i class="fas fa-edit"></i></button>
            <button class="text-red-600 hover:text-red-800 mr-3" onclick="confirmDelete(this)" title="Delete"><i class="fas fa-trash"></i></button>
            {% if b.status == 'available' %}
            <button class="px-3 py-1 bg-indigo-600 text-white rounded hover:bg-indigo-700" onclick="openIssue(this)">Issue</button>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr><td colspan="6" class="px-4 py-6 text-center text-gray-500">No books found</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div id="booksPagination" class="mt-4 flex justify-center"></div>

  <form id="deleteBookForm" method="POST" class="hidden"></form>
</div>

<!-- Add Book Modal -->
<div id="addBookModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg p-6 w-full max-w-md">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold">Add Book</h2>
      <button onclick="toggleModal('addBookModal', true)"><i class="fas fa-times text-gray-500"></i></button>
    </div>
    <form method="POST" action="{{ url_for('add_book') }}" class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-1">Book ID</label>
        <input name="book_id" required class="w-full p-2 border rounded" placeholder="e.g., BK-0001">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Title</label>
        <input name="title" required class="w-full p-2 border rounded">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Author</label>
        <input name="author" required class="w-full p-2 border rounded">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Price</label>
        <input name="price" type="number" min="0" step="0.01" required class="w-full p-2 border rounded">
      </div>
      <div class="flex justify-end gap-2 pt-2">
        <button type="button" class="px-4 py-2 border rounded" onclick="toggleModal('addBookModal', true)">Cancel</button>
        <button class="px-4 py-2 bg-blue-600 text-white rounded" type="submit">Add</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Book Modal -->
<div id="editBookModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg p-6 w-full max-w-md">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold">Edit Book</h2>
      <button onclick="toggleModal('editBookModal', true)"><i class="fas fa-times text-gray-500"></i></button>
    </div>
    <form id="editBookForm" method="POST" action="#" class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-1">Book ID</label>
        <input name="book_id" required class="w-full p-2 border rounded">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Title</label>
        <input name="title" required class="w-full p-2 border rounded">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Author</label>
        <input name="author" required class="w-full p-2 border rounded">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Price</label>
        <input name="price" type="number" min="0" step="0.01" required class="w-full p-2 border rounded">
      </div>
      <div class="flex justify-end gap-2 pt-2">
        <button type="button" class="px-4 py-2 border rounded" onclick="toggleModal('editBookModal', true)">Cancel</button>
        <button class="px-4 py-2 bg-blue-600 text-white rounded" type="submit">Save</button>
      </div>
    </form>
  </div>
</div>

<!-- Issue Book Modal -->
<div id="issueBookModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg p-6 w-full max-w-md">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold">Issue Book</h2>
      <button onclick="toggleModal('issueBookModal', true)"><i class="fas fa-times text-gray-500"></i></button>
    </div>
    <form id="issueBookForm" method="POST" action="#" class="space-y-4">
      <div class="p-3 bg-gray-50 rounded text-sm">
        <div><span class="text-gray-500">Book</span> <span class="font-medium" id="issueBookInfo"></span></div>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Student SWD ID</label>
        <input name="student_swd_id" class="w-full p-2 border rounded" placeholder="e.g., SWD12345">
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">or Student Name</label>
        <input name="student_name" class="w-full p-2 border rounded" placeholder="Exact full name">
      </div>
      <div class="text-xs text-gray-500">Provide SWD ID or exact full name.</div>
      <div class="flex justify-end gap-2 pt-2">
        <button type="button" class="px-4 py-2 border rounded" onclick="toggleModal('issueBookModal', true)">Cancel</button>
        <button class="px-4 py-2 bg-blue-600 text-white rounded" type="submit">Issue</button>
      </div>
    </form>
  </div>
</div>

<script>
function toggleModal(id, hide){
  const el = document.getElementById(id);
  if(!el) return;
  hide ? el.classList.add('hidden') : el.classList.remove('hidden');
}

(function(){
  const rows = Array.from(document.querySelectorAll('.book-row'));
  const search = document.getElementById('bookSearch');
  const pager = document.getElementById('booksPagination');
  const perPage = 10;
  let currentRows = [];
  let current = 1;

  function applyFilter(){
    const q = (search?.value || '').trim().toLowerCase();
    currentRows = rows.filter(tr => {
      const id = (tr.dataset.bookId||'').toLowerCase();
      const title = (tr.dataset.title||'').toLowerCase();
      const author = (tr.dataset.author||'').toLowerCase();
      return !q || id.includes(q) || title.includes(q) || author.includes(q);
    }).sort((a,b)=> (a.dataset.title||'').localeCompare(b.dataset.title||'', undefined, {sensitivity:'base'}));
    renderPage(1);
  }

  function renderPage(n){
    rows.forEach(tr=> tr.style.display='none');
    const totalPages = Math.max(1, Math.ceil(currentRows.length / perPage));
    current = Math.min(Math.max(1,n), totalPages);
    const start = (current-1)*perPage;
    const end = start + perPage;
    currentRows.slice(start,end).forEach(tr=> tr.style.display='');
    renderPager(totalPages);
  }

  function renderPager(totalPages){
    if(!pager) return;
    pager.innerHTML = '';
    if(currentRows.length === 0) return;
    const nav = document.createElement('nav');
    nav.className = 'inline-flex rounded-md shadow overflow-hidden';
    const prev = document.createElement('button');
    prev.className = 'px-3 py-2 border border-gray-300 bg-white text-gray-600 hover:bg-gray-50';
    prev.innerHTML = '<i class="fas fa-chevron-left"></i>';
    prev.disabled = current === 1;
    prev.onclick = ()=> renderPage(current-1);
    nav.appendChild(prev);
    for(let i=1;i<=totalPages;i++){
      const b = document.createElement('button');
      b.className = 'px-4 py-2 border-t border-b border-gray-300 ' + (i===current ? 'bg-blue-600 text-white font-medium' : 'bg-white text-gray-700 hover:bg-gray-50');
      b.textContent = String(i);
      b.onclick = ()=> renderPage(i);
      nav.appendChild(b);
    }
    const next = document.createElement('button');
    next.className = 'px-3 py-2 border border-gray-300 bg-white text-gray-600 hover:bg-gray-50';
    next.innerHTML = '<i class="fas fa-chevron-right"></i>';
    next.disabled = current >= totalPages;
    next.onclick = ()=> renderPage(current+1);
    nav.appendChild(next);
    pager.appendChild(nav);
  }

  window.openEdit = function(btn){
    const tr = btn.closest('tr');
    const id = tr?.dataset.bookOid;
    if(!tr || !id) return;
    const form = document.getElementById('editBookForm');
    form.action = `/admin/books/${id}/edit`;
    form.book_id.value = tr.dataset.bookId || '';
    form.title.value = tr.dataset.title || '';
    form.author.value = tr.dataset.author || '';
    const priceCell = tr.children[3]?.textContent?.trim() || '0';
    form.price.value = priceCell.replace(/[^0-9.]/g,'');
    toggleModal('editBookModal');
  }

  window.confirmDelete = function(btn){
    const tr = btn.closest('tr');
    const id = tr?.dataset.bookOid;
    if(!id) return;
    if(confirm('Delete this book?')){
      const f = document.getElementById('deleteBookForm');
      f.action = `/admin/books/${id}/delete`;
      f.submit();
    }
  }

  window.openIssue = function(btn){
    const tr = btn.closest('tr');
    const id = tr?.dataset.bookOid;
    if(!id) return;
    const form = document.getElementById('issueBookForm');
    form.action = `/admin/books/${id}/issue`;
    document.getElementById('issueBookInfo').textContent = `${tr.dataset.bookId} — ${tr.dataset.title}`;
    form.student_swd_id.value = '';
    form.student_name.value = '';
    toggleModal('issueBookModal');
  }

  if(search) search.addEventListener('input', applyFilter);
  applyFilter();
})();
</script>
{% endblock %}
